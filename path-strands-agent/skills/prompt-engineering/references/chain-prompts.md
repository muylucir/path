# Chain Prompts (Multi-turn 프롬프트 설계)

## 개념

Chain Prompts는 여러 턴의 대화를 통해 복잡한 작업을 수행하는 프롬프트 설계 전략입니다.

## 체인 유형

### 1. Sequential Chain (순차 체인)

이전 출력이 다음 입력이 되는 구조

```
[Prompt 1] → Output 1 → [Prompt 2 + Output 1] → Output 2 → ...
```

**예시: 콘텐츠 생성 파이프라인**

```
Turn 1 (개요 생성):
"다음 주제에 대한 블로그 글 개요를 작성하세요: [주제]"
→ Output: 개요

Turn 2 (본문 작성):
"다음 개요를 바탕으로 본문을 작성하세요:
[Turn 1 Output]"
→ Output: 본문

Turn 3 (편집):
"다음 글을 검토하고 개선하세요:
[Turn 2 Output]"
→ Output: 최종 글
```

### 2. Refinement Chain (개선 체인)

반복적으로 출력을 개선하는 구조

```
[Generate] → [Critique] → [Refine] → [Critique] → ...
```

**예시: 코드 개선**

```
Turn 1 (초기 생성):
"다음 요구사항에 맞는 함수를 작성하세요: [요구사항]"
→ Output: 초기 코드

Turn 2 (검토):
"다음 코드를 검토하고 문제점을 찾으세요:
[Turn 1 Output]"
→ Output: 문제점 목록

Turn 3 (개선):
"다음 피드백을 반영하여 코드를 개선하세요:
원본 코드: [Turn 1 Output]
피드백: [Turn 2 Output]"
→ Output: 개선된 코드
```

### 3. Branching Chain (분기 체인)

조건에 따라 다른 프롬프트로 분기

```
[Classify] → Category A → [Prompt A]
           → Category B → [Prompt B]
```

**예시: 고객 문의 처리**

```
Turn 1 (분류):
"다음 문의를 분류하세요: [고객 문의]
카테고리: billing, support, sales"
→ Output: {"category": "billing"}

Turn 2a (billing 경로):
"결제 관련 문의입니다. 다음 정보를 확인하세요:
[고객 문의]
필요한 정보: 주문번호, 결제일, 금액"

Turn 2b (support 경로):
"기술 지원 문의입니다. 다음 문제를 진단하세요:
[고객 문의]
확인 사항: 오류 메시지, 발생 시점, 재현 방법"
```

## 컨텍스트 전달 전략

### 명시적 컨텍스트 전달

```
이전 대화:
User: [이전 질문]
Assistant: [이전 답변]

현재 질문: [새 질문]

이전 대화를 참고하여 답변하세요.
```

### 요약 컨텍스트 전달

```
지금까지의 작업 요약:
- 1단계 완료: [요약]
- 2단계 완료: [요약]

다음 단계를 진행하세요: [지시]
```

### 구조화된 상태 전달

```json
{
  "current_step": 3,
  "previous_outputs": {
    "step1": "분석 결과...",
    "step2": "계획..."
  },
  "accumulated_data": {...}
}
```

## Multi-Agent Chain

여러 Agent가 순차적으로 작업하는 체인

```
[Researcher] → 자료 → [Writer] → 초안 → [Editor] → 최종본
```

### 프롬프트 설계

**Researcher Agent:**
```
당신은 리서처입니다.
다음 주제를 조사하고 핵심 정보를 정리하세요: [주제]

출력 형식:
{
  "key_findings": [...],
  "sources": [...],
  "data_points": [...]
}
```

**Writer Agent:**
```
당신은 작가입니다.
다음 조사 결과를 바탕으로 글을 작성하세요:

[Researcher Output]

글 조건:
- 길이: 1000자
- 톤: 전문적
- 구조: 서론-본론-결론
```

**Editor Agent:**
```
당신은 편집자입니다.
다음 글을 검토하고 개선하세요:

[Writer Output]

검토 기준:
- 문법 및 맞춤법
- 논리적 흐름
- 가독성
```

## 체인 종료 조건

### 품질 기반 종료

```
반복 조건:
- 품질 점수가 8/10 이상이면 종료
- 최대 3회 반복

현재 점수: [점수]
반복 횟수: [횟수]

점수가 8 미만이면 다음을 개선하세요: [피드백]
```

### 완료 기반 종료

```
작업 체크리스트:
- [x] 요구사항 분석
- [x] 설계
- [ ] 구현
- [ ] 테스트

다음 미완료 항목을 진행하세요.
모든 항목이 완료되면 "DONE"을 출력하세요.
```

## 오류 처리

### 재시도 프롬프트

```
이전 시도가 실패했습니다.
오류: [오류 메시지]

다음 점을 수정하여 다시 시도하세요:
- [수정 사항 1]
- [수정 사항 2]
```

### 대안 경로

```
[작업]이 불가능한 경우:
1. 먼저 [대안 1]을 시도하세요
2. 그래도 안 되면 [대안 2]를 시도하세요
3. 모두 실패하면 "NEED_HELP"를 반환하세요
```

## 주의사항

1. **컨텍스트 크기 관리**: 체인이 길어지면 컨텍스트 압축 필요
2. **오류 전파 방지**: 이전 단계 오류가 전체에 영향 주지 않도록
3. **명확한 전환**: 각 턴의 역할과 기대 출력 명확히
4. **종료 조건**: 무한 루프 방지를 위한 명확한 종료 조건
