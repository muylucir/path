# Human-in-the-Loop Pattern (사람 협업)

## 개념

Human-in-the-Loop 패턴은 Agent가 작업을 수행하되, 중요한 시점에서 사람의 검토나 승인을 받는 방식입니다.

```
Agent Work -> Checkpoint -> Human Review -> Approved? -> Continue/Revise
```

## 핵심 구성 요소

### 1. Autonomous Phase (자율 단계)
- Agent가 독립적으로 작업 수행
- 중간 결과물 생성

### 2. Checkpoint (체크포인트)
- 사람 개입이 필요한 시점
- 검토 요청 및 대기

### 3. Human Review (사람 검토)
- 결과물 검토
- 승인, 수정 요청, 또는 거절

### 4. Feedback Integration (피드백 통합)
- 사람의 피드백 반영
- 수정 후 재제출

## 적합한 상황

| 상황 | 설명 |
|------|------|
| 중요한 결정 | 비용, 법적 영향이 큰 결정 |
| 높은 정확도 | 오류가 허용되지 않는 작업 |
| 규정 준수 | 승인이 필수인 프로세스 |
| 학습 단계 | Agent 신뢰도 확보 전 |

## 개입 유형

### 1. Approval (승인)
- Agent 제안을 검토 후 승인/거부
- 예: 이메일 발송 전 승인

### 2. Exception Handling (예외 처리)
- 불확실한 경우에만 개입
- 예: 신뢰도 낮은 분류 결과

### 3. Collaboration (협업)
- Agent와 사람이 함께 작업
- 예: 문서 공동 편집

### 4. Escalation (에스컬레이션)
- 특정 조건에서 상위 권한으로 전달
- 예: 고액 거래 승인

## State 관리

| State 유형 | 내용 | 예시 |
|-----------|------|------|
| **Pending Review** | 검토 대기 중인 작업 | 승인 요청 목록 |
| **Review History** | 검토 이력 | 이전 피드백, 수정 내역 |
| **Approval Status** | 승인 상태 | 승인됨/거부됨/대기중 |
| **Feedback** | 사람 피드백 | 수정 요청 내용 |

## 예제: 계약서 검토 Agent

### Agent 구성

```
Contract Review Agent
├── Analyzer
│   └── 계약서 분석 및 요약
├── Risk Assessor
│   └── 위험 조항 식별
├── Checkpoint
│   └── 변호사 검토 요청
└── Finalizer
    └── 최종 보고서 생성
```

### System Prompt 예시

```
당신은 계약서 분석 전문가입니다.

계약서를 분석할 때:
1. 핵심 조항을 요약하세요
2. 잠재적 위험 조항을 식별하세요
3. 검토가 필요한 항목을 표시하세요

중요한 발견이 있으면 반드시 사람 검토를 요청하세요:
- 비정상적인 조항
- 높은 재무적 위험
- 법적 모호성
```

### 실행 흐름 예시

```
User: "공급 계약서 검토해줘"

[Agent Analysis]
- 계약 기간: 2년
- 총 금액: 5억원
- 지급 조건: 선불 30%, 납품 후 70%

[Risk Assessment]
- 위험 1: 해지 시 위약금 조항 (금액의 50%)
- 위험 2: 분쟁 해결 - 공급자 소재지 법원

[Checkpoint - Human Review Required]
"다음 조항에 대한 검토가 필요합니다:
1. 위약금 조항 (50%)이 업계 평균(20-30%)보다 높습니다
2. 분쟁 해결 조항이 불리할 수 있습니다

검토 후 다음 중 선택해주세요:
- [승인] 현재 조건으로 진행
- [협상 요청] 조건 수정 협상
- [거부] 계약 거절"

[Human Decision] 협상 요청

[Agent Action] 협상 포인트 정리 및 제안서 작성
```

## 체크포인트 설계

### 언제 체크포인트를 둘까?

| 기준 | 체크포인트 예시 |
|------|----------------|
| **금액 기준** | 100만원 이상 결제 시 |
| **위험 수준** | 위험 점수 7/10 이상 시 |
| **불확실성** | 신뢰도 80% 미만 시 |
| **프로세스 규정** | 최종 실행 전 항상 |

### 체크포인트 인터페이스

```json
{
  "checkpoint_id": "cp-001",
  "type": "approval",
  "summary": "이메일 발송 승인 요청",
  "details": {
    "action": "send_email",
    "recipients": ["customer@example.com"],
    "subject": "주문 확인",
    "preview": "..."
  },
  "options": [
    { "action": "approve", "label": "승인" },
    { "action": "edit", "label": "수정" },
    { "action": "reject", "label": "거부" }
  ],
  "timeout": "24h"
}
```

## 주의사항

1. **병목 방지**: 체크포인트가 너무 많으면 워크플로우 지연
2. **명확한 기준**: 언제 체크포인트가 필요한지 명확히 정의
3. **타임아웃 처리**: 검토가 늦어질 경우 대응 방안
4. **피드백 품질**: 사람의 피드백이 Agent에 명확히 전달되도록
5. **학습 반영**: 반복되는 패턴은 자동화 고려
