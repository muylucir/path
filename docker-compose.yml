version: '3.8'

services:
  path-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: path-agent-designer
    ports:
      - "3009:3009"
    environment:
      # AWS Configuration
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-west-2}
      - AWS_REGION=${AWS_REGION:-us-west-2}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN:-}
      # Application Configuration
      - STRANDS_API_URL=http://localhost:8001
      - NODE_ENV=production
    volumes:
      # Mount AWS credentials (optional, for development)
      - ${HOME}/.aws:/root/.aws:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3009/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Development service with volume mounts for hot reload
  path-agent-dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: path-agent-designer-dev
    ports:
      - "3009:3009"
    environment:
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-west-2}
      - AWS_REGION=${AWS_REGION:-us-west-2}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN:-}
      - STRANDS_API_URL=http://localhost:8001
      - NODE_ENV=development
    volumes:
      - ${HOME}/.aws:/root/.aws:ro
      # Mount source for development (note: won't enable hot reload without additional config)
      - ./path-strands-agent:/app/backend:ro
    profiles:
      - dev
    restart: unless-stopped
